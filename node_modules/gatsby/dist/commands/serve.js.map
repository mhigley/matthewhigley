{"version":3,"sources":["../../src/commands/serve.js"],"names":["path","require","openurl","fs","signalExit","compression","express","getConfigFile","preferDefault","chalk","reachMatch","match","telemetry","getPages","directory","readFile","join","then","contents","JSON","parse","catch","clientOnlyPathsRouter","pages","options","clientOnlyRoutes","filter","page","matchPath","req","res","next","url","accepts","route","find","clientRoute","sendFile","err","module","exports","program","trackCli","prefixPaths","port","open","host","parseInt","config","pathPrefix","root","app","router","Router","use","expressMiddleware","static","status","server","listen","openUrlString","console","log","blue","bold","Promise","resolve","yellow","close"],"mappings":"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","sourcesContent":["/* @flow weak */\nconst path = require(`path`)\nconst openurl = require(`better-opn`)\nconst fs = require(`fs-extra`)\nconst signalExit = require(`signal-exit`)\nconst compression = require(`compression`)\nconst express = require(`express`)\nconst getConfigFile = require(`../bootstrap/get-config-file`)\nconst preferDefault = require(`../bootstrap/prefer-default`)\nconst chalk = require(`chalk`)\nconst { match: reachMatch } = require(`@reach/router/lib/utils`)\n\nconst telemetry = require(`gatsby-telemetry`)\n\nconst getPages = directory =>\n  fs\n    .readFile(path.join(directory, `.cache`, `pages.json`))\n    .then(contents => JSON.parse(contents))\n    .catch(() => [])\n\nconst clientOnlyPathsRouter = (pages, options) => {\n  const clientOnlyRoutes = pages.filter(page => page.matchPath)\n  return (req, res, next) => {\n    const { url } = req\n    if (req.accepts(`html`)) {\n      const route = clientOnlyRoutes.find(\n        clientRoute => reachMatch(clientRoute.matchPath, url) !== null\n      )\n      if (route && route.path) {\n        return res.sendFile(\n          path.join(route.path, `index.html`),\n          options,\n          err => {\n            if (err) {\n              next()\n            }\n          }\n        )\n      }\n    }\n    return next()\n  }\n}\n\nmodule.exports = async program => {\n  telemetry.trackCli(`SERVE_START`)\n  let { prefixPaths, port, open, host } = program\n  port = typeof port === `string` ? parseInt(port, 10) : port\n\n  const config = await preferDefault(\n    getConfigFile(program.directory, `gatsby-config`)\n  )\n\n  let pathPrefix = config && config.pathPrefix\n  pathPrefix = prefixPaths && pathPrefix ? pathPrefix : `/`\n\n  const root = path.join(program.directory, `public`)\n  const pages = await getPages(program.directory)\n\n  const app = express()\n  const router = express.Router()\n\n  app.use(telemetry.expressMiddleware(`SERVE`))\n\n  router.use(compression())\n  router.use(express.static(`public`))\n  router.use(clientOnlyPathsRouter(pages, { root }))\n  router.use((req, res, next) => {\n    if (req.accepts(`html`)) {\n      return res.status(404).sendFile(`404.html`, { root })\n    }\n    return next()\n  })\n  app.use(pathPrefix, router)\n\n  const server = app.listen(port, host, () => {\n    let openUrlString = `http://${host}:${port}${pathPrefix}`\n    console.log(\n      `${chalk.blue(`info`)} gatsby serve running at: ${chalk.bold(\n        openUrlString\n      )}`\n    )\n    if (open) {\n      console.log(`${chalk.blue(`info`)} Opening browser...`)\n      Promise.resolve(openurl(openUrlString)).catch(err =>\n        console.log(\n          `${chalk.yellow(\n            `warn`\n          )} Browser not opened because no browser was found`\n        )\n      )\n    }\n  })\n\n  signalExit(() => {\n    telemetry.trackCli(`SERVE_STOP`)\n    server.close()\n  })\n}\n"],"file":"serve.js"}